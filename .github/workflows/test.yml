name: Tests

on: [push, pull_request, workflow_dispatch]

jobs:
  test:
    strategy:
      matrix:
        platform:
          - {
            icon: ğŸ§,
            label: Linux,
            runner: ubuntu-latest
          }
          - {
            icon: ğŸ,
            label: macOS,
            runner: macos-latest
          }
          - {
            icon: ğŸ,
            label: Windows,
            runner: windows-latest
          }
        # Earliest supported and latest nim
        nim: [1.6.18, "stable"]
    name: ${{ matrix.platform.icon }} ${{ matrix.platform.label }} - Nim v${{ matrix.nim }}
    runs-on: ${{ matrix.platform.runner }}
    defaults:
      run:
        shell: bash
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    - uses: jiro4989/setup-nim-action@v2
      with:
        nim-version: ${{matrix.nim}}
        repo-token: ${{ secrets.GITHUB_TOKEN }}
    - name: Install
      run: nimble install -y
    - name: Build and run tests
      run: |
        eval nimble --verbose test -d:release --mm:refc
        eval nimble --verbose test -d:release --mm:orc
